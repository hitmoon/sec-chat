code from http://sechat.googlecode.com/svn/trunk
